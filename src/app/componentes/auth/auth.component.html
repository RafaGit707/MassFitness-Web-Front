<div class="container-header" #containerHeader>

    <ng-container *ngIf="isHomePage"> <!-- Mostrar solo en la home -->
        <div class="div-fondo"></div>
        <section class="img-titulo">
            <img src="../assets/massfitness_nobackground.webp" alt="MassFitness" class="img-top" loading="lazy">
            <h1 class="titulo-top">Bienvenidos a MassFitness</h1>
        </section>
    </ng-container>

    <header #headerElement>
        <div class="topheader">
        <div class="logo-container"> <!-- Contenedor para logo y enlaces de escritorio -->
            <a routerLink="/"> <!-- Enlace a la home -->
                <img src="../assets/massfitness_nobackground.webp" alt="MassFitness" class="img-logo" loading="lazy">
            </a>
            <nav class="nav-enlaces nav-enlaces-desktop">
                <ul>
                    <!-- <li><a routerLink="/servicios">Servicios</a></li>
                    <li class="nav-item dropdown-container"
                        (mouseenter)="showClasesDropdownDesktop = true" (mouseleave)="showClasesDropdownDesktop = false">
                    <a class="enlaces has-dropdown" (click)="toggleClasesDropdownDesktop()" [class.active]="showClasesDropdownDesktop">
                        Clases <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
                    </a>
                    <div class="dropdown-menu desktop-dropdown" *ngIf="showClasesDropdownDesktop">
                        <div *ngIf="isLoadingClases" class="dropdown-loader">
                        <mat-spinner diameter="20"></mat-spinner>
                        </div>
                        <a *ngFor="let clase of clasesDisponibles" class="dropdown-item" (click)="navegarADetalle('clase', clase.id)">
                        <mat-icon *ngIf="clase.tipoIcono">{{clase.tipoIcono}}</mat-icon>
                        <mat-icon *ngIf="!clase.tipoIcono">fitness_center</mat-icon>
                        {{ clase.nombre }}
                        </a>
                        <div *ngIf="!isLoadingClases && clasesDisponibles.length === 0" class="dropdown-item-empty">
                        No hay clases.
                        </div>
                    </div>
                    </li>

                    <li class="nav-item dropdown-container"
                        (mouseenter)="showSalasDropdownDesktop = true" (mouseleave)="showSalasDropdownDesktop = false">
                    <a class="enlaces has-dropdown" (click)="toggleSalasDropdownDesktop()" [class.active]="showSalasDropdownDesktop">
                        Espacios <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
                    </a>
                    <div class="dropdown-menu desktop-dropdown" *ngIf="showSalasDropdownDesktop">
                        <div *ngIf="isLoadingSalas" class="dropdown-loader">
                        <mat-spinner diameter="20"></mat-spinner>
                        </div>
                        <a *ngFor="let sala of salasDisponibles" class="dropdown-item" (click)="navegarADetalle('sala', sala.id)">
                        <mat-icon *ngIf="sala.tipoIcono">{{sala.tipoIcono}}</mat-icon>
                        <mat-icon *ngIf="!sala.tipoIcono">meeting_room</mat-icon>
                        {{ sala.nombre }}
                        </a>
                        <div *ngIf="!isLoadingSalas && salasDisponibles.length === 0" class="dropdown-item-empty">
                        No hay espacios.
                        </div>
                    </div>
                    </li> -->

                     <li #clasesDropdownContainer class="nav-item dropdown-container"
                     (mouseenter)="onDropdownContainerMouseEnter($event, 'clases')"
                     (mouseleave)="onDropdownContainerMouseLeave('clases')">
                        <a class="enlaces has-dropdown" (click)="toggleClasesDropdownDesktop($event)" [class.active]="showClasesDropdownDesktop">
                            Clases <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
                        </a>
                        <div class="dropdown-menu desktop-dropdown"
                            data-type="clases"
                            *ngIf="showClasesDropdownDesktop"
                            [class.dropdown-active]="showClasesDropdownDesktop"
                            [class.drop-up]="isClasesDropUp">
                            <a *ngFor="let clase of clasesDisponibles" class="dropdown-item" (click)="navegarADetalle('clase', clase.id)">
                                <mat-icon *ngIf="clase.tipoIcono">{{clase.tipoIcono}}</mat-icon>
                                <mat-icon *ngIf="!clase.tipoIcono">fitness_center</mat-icon>
                                {{ clase.nombre }}
                            </a>
                            <div *ngIf="!isLoadingClases && clasesDisponibles.length === 0" class="dropdown-item-empty">
                            No hay clases.
                            </div>
                        </div>
                    </li>

                    <li #salasDropdownContainer class="nav-item dropdown-container"
                        (mouseenter)="onDropdownContainerMouseEnter($event, 'salas')"
                        (mouseleave)="onDropdownContainerMouseLeave('salas')">
                        <a class="enlaces has-dropdown" (click)="toggleSalasDropdownDesktop($event)" [class.active]="showSalasDropdownDesktop">
                            Espacios <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
                        </a>
                        <div class="dropdown-menu desktop-dropdown"
                            data-type="salas"
                            *ngIf="showSalasDropdownDesktop"
                            [class.dropdown-active]="showSalasDropdownDesktop"
                            [class.drop-up]="isSalasDropUp">
                            <a *ngFor="let sala of salasDisponibles" class="dropdown-item" (click)="navegarADetalle('sala', sala.id)">
                                <mat-icon *ngIf="sala.tipoIcono">{{sala.tipoIcono}}</mat-icon>
                                <mat-icon *ngIf="!sala.tipoIcono">meeting_room</mat-icon>
                                {{ sala.nombre }}
                            </a>
                            <div *ngIf="!isLoadingSalas && salasDisponibles.length === 0" class="dropdown-item-empty">
                                No hay espacios.
                            </div>
                        </div>
                    </li>

                    <li><a routerLink="/boxeo">Boxeo</a></li>
                    <li><a routerLink="#" (click)="scrollToContact('#contacto')">Contacto</a></li>
                    </ul>
                </nav>
            </div>
        
            <div class="session-burger-container"> <!-- Contenedor para botones de sesión (escritorio) y hamburguesa (móvil) -->
                <div *ngIf="loggedIn" class="mobile-user-info">
                    <span class="user"><a routerLink="/perfil" (click)="closeMenuAndNavigate()">{{ currentUserName }}</a></span>
                </div>
                <nav class="nav-session nav-session-desktop"> <!-- Botones de sesión solo para escritorio -->
                    <ul>
                        <li *ngIf="!loggedIn">
                            <button type="button" class="button-iniciar-sesion" (click)="openLogin()">
                            Iniciar Sesión
                            </button>
                        </li>
                        <li class="user-sesion" *ngIf="loggedIn">
                            <span class="user"><a routerLink="/perfil"> {{ currentUserName }}</a></span>
                            <button (click)="logout()" type="button" class="button-cerrar-sesion">Cerrar sesión</button>
                            <a *ngIf="isAdmin" routerLink="/admin-dashboard" class="enlaces-admin button-admin-panel">Admin Panel</a>
                        </li>
                    </ul>
                </nav>
                <!-- Icono de Hamburguesa para Móvil -->
                <div class="burger-menu-icon" (click)="toggleMobileMenu()" [class.active]="isMobileMenuOpen">
                    <div class="bar1"></div>
                    <div class="bar2"></div>
                    <div class="bar3"></div>
                </div>
            </div>
        </div>
    </header>
</div>

<!-- 3. Menú Móvil (Overlay) -->
<div class="mobile-menu-overlay" [class.open]="isMobileMenuOpen">
    <div class="mobile-menu-header">
        <a routerLink="/" (click)="closeMenuAndNavigate()">
            <img src="../assets/massfitness_nobackground.webp" class="mobile-menu-logo" alt="MassFitness Logo">
        </a>
        <div class="mobile-session-controls">
            <button *ngIf="!loggedIn" type="button" class="button-iniciar-sesion mobile" (click)="openLoginAndCloseMenu()">
                Iniciar Sesión
            </button>
            <div>
                <div *ngIf="isAdmin">
                    <button type="button" class="button-admin-panel">
                        <a class="enlaces-admin" routerLink="/admin-dashboard" (click)="closeMenuAndNavigate()">Admin Panel</a>
                    </button>
                </div>
            </div>    
        </div>
        <img src="../assets/X-purple.webp" class="mobile-menu-close" (click)="toggleMobileMenu()" alt="Cerrar menú">
    </div>
    <nav class="mobile-menu-nav">
        <ul>
            <hr *ngIf="loggedIn">

            <!-- DENTRO DE: <nav class="mobile-menu-nav"> <ul> ... </ul> </nav> -->

            <!-- ITEM DE CLASES CON SUBMENÚ MÓVIL -->
            <li class="mobile-nav-item has-submenu">
            <a (click)="toggleClasesSubmenuMobile()" class="mobile-submenu-trigger" [class.active]="showClasesSubmenuMobile">
                <span><mat-icon>class</mat-icon> Clases</span>
                <mat-icon class="submenu-arrow">{{ showClasesSubmenuMobile ? 'expand_less' : 'expand_more' }}</mat-icon>
            </a>
            <ul class="mobile-submenu" [@expandCollapse]="showClasesSubmenuMobile ? 'expanded' : 'collapsed'">
                <li *ngIf="isLoadingClases" class="submenu-loader"><mat-spinner diameter="25"></mat-spinner></li>
                <li *ngFor="let clase of clasesDisponibles">
                <a (click)="navegarADetalle('clase', clase.id)">
                    <mat-icon *ngIf="clase.tipoIcono">{{clase.tipoIcono}}</mat-icon>
                    <mat-icon *ngIf="!clase.tipoIcono">fitness_center</mat-icon>
                    {{ clase.nombre }}
                </a>
                </li>
                <li *ngIf="!isLoadingClases && clasesDisponibles.length === 0" class="submenu-item-empty">
                <a>No hay clases.</a>
                </li>
            </ul>
            </li>

            <!-- ITEM DE ESPACIOS CON SUBMENÚ MÓVIL -->
            <li class="mobile-nav-item has-submenu">
            <a (click)="toggleSalasSubmenuMobile()" class="mobile-submenu-trigger" [class.active]="showSalasSubmenuMobile">
                <span><mat-icon>sensor_door</mat-icon> Espacios</span>
                <mat-icon class="submenu-arrow">{{ showSalasSubmenuMobile ? 'expand_less' : 'expand_more' }}</mat-icon>
            </a>
            <ul class="mobile-submenu" [@expandCollapse]="showSalasSubmenuMobile ? 'expanded' : 'collapsed'">
                <li *ngIf="isLoadingSalas" class="submenu-loader"><mat-spinner diameter="25"></mat-spinner></li>
                <li *ngFor="let sala of salasDisponibles">
                <a (click)="navegarADetalle('sala', sala.id)">
                    <mat-icon *ngIf="sala.tipoIcono">{{sala.tipoIcono}}</mat-icon>
                    <mat-icon *ngIf="!sala.tipoIcono">meeting_room</mat-icon>
                    {{ sala.nombre }}
                </a>
                </li>
                <li *ngIf="!isLoadingSalas && salasDisponibles.length === 0" class="submenu-item-empty">
                <a>No hay espacios.</a>
                </li>
            </ul>
            </li>

            <!-- Tus otros enlaces móviles (Servicios, Boxeo, Contacto) -->
            <li><a routerLink="/servicios" (click)="closeMenuAndNavigate()"><mat-icon>miscellaneous_services</mat-icon>Servicios</a></li>
            <li><a routerLink="/boxeo" (click)="closeMenuAndNavigate()"><mat-icon>sports_mma</mat-icon>Boxeo</a></li>
            <li><a (click)="closeMenuAndNavigate('#contacto')"><mat-icon>contact_support</mat-icon>Contacto</a></li>

            <!-- ... (resto de tu menú móvil, hr, botones de sesión, etc.) ... -->

            <!-- <li><a routerLink="/boxeo" (click)="closeMenuAndNavigate()">Boxeo</a></li>
            <li><a routerLink="/servicios" (click)="closeMenuAndNavigate()">Servicios</a></li>
            <li><a (click)="closeMenuAndNavigate('#contacto')">Contacto</a></li> -->

            <ng-container *ngIf="loggedIn">
                <hr>
                
                <!-- <li *ngIf="isAdmin"><a routerLink="/admin-dashboard" (click)="closeMenuAndNavigate()">Panel de Admin</a></li> -->
                <!-- Aquí podrías añadir más enlaces específicos de admin si los tuvieras separados en Vue -->
                <!-- Ejemplo de submenú de admin si fuera necesario (más complejo) -->
<!--                 
                <ng-container *ngIf="isAdmin">
                    <hr>
                    <li class="mobile-menu-section-title"><a>Gestión Admin</a></li>
                    <li><a routerLink="/admin-dashboard/articulos" (click)="closeMenuAndNavigate()">Artículos</a></li>
                    <li><a routerLink="/admin-dashboard/usuarios" (click)="closeMenuAndNavigate()">Usuarios</a></li>
                </ng-container>
                -->
                <hr>
                <li class="li-cerrar-sesion" (click)="logoutAndCloseMenu()">
                    <button type="button" class="button-cerrar-sesion">Cerrar Sesión</button>
                </li>
                
            </ng-container>
        </ul>
    </nav>
</div>

<div id="mostrar" class="container1" *ngIf="showLoginModal">
    <div class="fondo"></div>
    <div class="contenido">
        <form class="form-container" (ngSubmit)="onLoginSubmit(loginForm)" #loginForm="ngForm">
        <h1>Iniciar sesión</h1>
        <div class="form-group">
            <label for="login-username">Nombre de usuario</label>
            <input type="text" id="login-username" name="nombre_usuario" autocomplete="off" [(ngModel)]="loginData.nombre_usuario" required #loginUsernameInput="ngModel" [ngClass]="{'input-error': loginForm.submitted && loginUsernameInput.invalid}">
            <div *ngIf="loginForm.submitted && loginUsernameInput.invalid" class="error-message">
                Nombre de usuario requerido.
            </div>
        </div>
        <div class="form-group">
            <label for="login-password">Contraseña</label>
            <input type="password" id="login-password" name="contrasena" autocomplete="off" [(ngModel)]="loginData.contrasena" required #loginPasswordInput="ngModel" [ngClass]="{'input-error': loginForm.submitted && loginPasswordInput.invalid}">
             <div *ngIf="loginForm.submitted && loginPasswordInput.invalid" class="error-message">
                Contraseña requerida.
            </div>
        </div>
        <div *ngIf="loginError" class="error-message">
            {{ loginError }}
        </div>
        <button class="submit-btn" type="submit" [disabled]="isLoadingLogin || !loginForm.valid">
            <span *ngIf="isLoadingLogin" class="spinner"></span>
            {{ isLoadingLogin ? 'Iniciando sesión...' : 'Iniciar sesión' }}
        </button>
        <p class="cuenta_p">¿No tienes cuenta?  <a href="#registro" class="registrarse" (click)="openRegister()">Registrarse</a></p>
        <a id="cerrar" class="cerrar" href="#" (click)="closeModals()"><img src="../assets/X-purple.webp" class="X1" id="X1" loading="lazy"></a>
        </form>
    </div>
</div>
    
<div id="registro" class="container1" *ngIf="showRegisterModal">
    <div class="fondo"></div>
    <div class="contenido">
        <form class="form-container" (ngSubmit)="onRegisterSubmit(registroForm)" #registroForm="ngForm">
        <h1>Registrarse</h1>
        <div class="form-group">
            <label for="register-nombre">Nombre</label>
            <input type="text" id="register-nombre" name="nombre" autocomplete="off" [(ngModel)]="registroData.nombre" required #regNombreInput="ngModel" [ngClass]="{'input-error': registroForm.submitted && regNombreInput.invalid}">
             <div *ngIf="registroForm.submitted && regNombreInput.invalid" class="error-message">
                    Nombre requerido.
             </div>
        </div>
        <div class="form-group">
            <label for="register-email">Correo electrónico</label>
            <input type="email" id="register-email" name="correo_electronico" autocomplete="off" [(ngModel)]="registroData.correo_electronico" required email #regEmailInput="ngModel" [ngClass]="{'input-error': registroForm.submitted && regEmailInput.invalid}">
             <div *ngIf="registroForm.submitted && regEmailInput.invalid" class="error-message">
                <span *ngIf="regEmailInput.errors?.['required']">Correo requerido.</span>
                <span *ngIf="regEmailInput.errors?.['email']">Correo inválido.</span>
             </div>
        </div>
        <div class="form-group">
            <label for="register-username">Nombre de usuario</label>
            <input type="text" id="register-username" name="nombre_usuario" autocomplete="off" [(ngModel)]="registroData.nombre_usuario" required #regUsernameInput="ngModel" [ngClass]="{'input-error': registroForm.submitted && regUsernameInput.invalid}">
             <div *ngIf="registroForm.submitted && regUsernameInput.invalid" class="error-message">
                Nombre de usuario requerido.
             </div>
        </div>
        <div class="form-group">
            <label for="register-password">Contraseña</label>
            <input type="password" id="register-password" name="contrasena" autocomplete="off" [(ngModel)]="registroData.contrasena" required
                   pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[#$@!%&*?_])(?!\s)[a-zA-Z\d#$@!%&*?_]{8,16}$"
                   (input)="checkPasswordStrength($any($event.target).value)"
                   #regPasswordInput="ngModel"
                   [ngClass]="{'input-error': (registroForm.submitted || regPasswordInput.touched) && regPasswordInput.invalid}">
             <div *ngIf="(registroForm.submitted || regPasswordInput.touched) && regPasswordInput.errors?.['required']" class="error-message">
                Contraseña requerida.
            </div>
             <div *ngIf="(registroForm.submitted || regPasswordInput.touched) && regPasswordInput.errors?.['pattern']" class="error-message">
               La contraseña no cumple los requisitos.
            </div>
        </div>
        <div *ngIf="registerError" class="error-message">
            {{ registerError }}
        </div>
        <div id="error-message" class="password-rules" *ngIf="registroForm.controls['contrasena']?.touched || registroForm.controls['contrasena']?.value">
            <p class="message" [ngClass]="{'valid': passwordValidation.length, 'invalid': !passwordValidation.length}">
                <img class="X2" [src]="passwordValidation.length ? 'assets/tick.webp' : 'assets/X.webp'" alt="Icon">La contraseña debe tener entre 8 y 16 caracteres
            </p>
            <p class="message" [ngClass]="{'valid': passwordValidation.lowercase, 'invalid': !passwordValidation.lowercase}">
                <img class="X2" [src]="passwordValidation.lowercase ? 'assets/tick.webp' : 'assets/X.webp'" alt="Icon">La contraseña debe contener al menos una letra minúscula
            </p>
            <p class="message" [ngClass]="{'valid': passwordValidation.uppercase, 'invalid': !passwordValidation.uppercase}">
                <img class="X2" [src]="passwordValidation.uppercase ? 'assets/tick.webp' : 'assets/X.webp'" alt="Icon">La contraseña debe contener al menos una letra mayúscula
            </p>
            <p class="message" [ngClass]="{'valid': passwordValidation.number, 'invalid': !passwordValidation.number}">
                <img class="X2" [src]="passwordValidation.number ? 'assets/tick.webp' : 'assets/X.webp'" alt="Icon">La contraseña debe contener al menos un número
            </p>
            <p class="message" [ngClass]="{'valid': passwordValidation.special, 'invalid': !passwordValidation.special}">
                <img class="X2" [src]="passwordValidation.special ? 'assets/tick.webp' : 'assets/X.webp'" alt="Icon">La contraseña debe contener al menos un carácter especial (#$&#64;!%&amp;*?_)
            </p>
        </div>
        <button class="submit-btn" type="submit" [disabled]="isLoadingRegister || !registroForm.valid">
            <span *ngIf="isLoadingRegister" class="spinner"></span>
           {{ isLoadingRegister ? 'Cargando...' : 'Registrarse' }}
       </button>
        <p class="cuenta_p">¿Tienes cuenta? <a href="#mostrar" class="registrarse" (click)="openLogin()">Iniciar Sesion</a></p>
        <a id="cerrar" class="cerrar" href="#" (click)="closeModals()"><img src="../assets/X-purple.webp" class="X1" id="X1"></a>
        </form>
    </div>
</div>